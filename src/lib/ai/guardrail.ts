/* ===========================
   Fortune Domain Guardrail
   ===========================
   
   ìš´ì„¸ ë„ë©”ì¸ ì™¸ ì§ˆë¬¸ì„ ì°¨ë‹¨í•˜ëŠ” ê°€ë“œë ˆì¼.
   ëª¨ë“  í‹°ì–´ì— ë™ì¼í•˜ê²Œ ì ìš© (í‹°ì–´ë¡œ ìš°íšŒ ë¶ˆê°€).
   
   íŒë³„ ë°©ì‹:
   1ì°¨: í‚¤ì›Œë“œ/ë£° ê¸°ë°˜ ë¹ ë¥¸ íŒë³„
   2ì°¨: ëª…ë°±íˆ ë¹„ìš´ì„¸ í‚¤ì›Œë“œê°€ ìˆìœ¼ë©´ ì°¨ë‹¨
   3ì°¨: ë‘˜ ë‹¤ í•´ë‹¹ ì—†ìœ¼ë©´ í—ˆìš© (false negative í—ˆìš© â€” ìš´ì„¸ ë§¥ë½ì—ì„œì˜ ì¼ë°˜ ì§ˆë¬¸ì€ í†µê³¼)
*/

export interface GuardrailResult {
    allowed: boolean;
    reason?: string;
}

// =============================
// ìš´ì„¸ ê´€ë ¨ í‚¤ì›Œë“œ (í—ˆìš© ì‹œê·¸ë„)
// =============================
const FORTUNE_KEYWORDS: Record<string, string[]> = {
    ko: [
        'ìš´ì„¸', 'ì‚¬ì£¼', 'íŒ”ì', 'íƒ€ë¡œ', 'ì ì„±ìˆ ', 'ë³„ìë¦¬', 'ê¶í•©', 'ì¬ë¬¼ìš´', 'ì—°ì• ìš´',
        'ì§ì¥ìš´', 'ê±´ê°•ìš´', 'ê¸ˆì „ìš´', 'í•™ì—…ìš´', 'ì‹œí—˜ìš´', 'ì˜¤ëŠ˜ì˜ ìš´ì„¸', 'ë‚´ì¼ì˜ ìš´ì„¸',
        'ì´ë²ˆì£¼ ìš´ì„¸', 'ì´ë²ˆë‹¬ ìš´ì„¸', 'ì˜¬í•´ ìš´ì„¸', 'ë ', 'ìƒë…„ì›”ì¼', 'ìŒë ¥', 'ì–‘ë ¥',
        'ëŒ€ìš´', 'ì‹­ì‹ ', 'ì˜¤í–‰', 'ì²œê°„', 'ì§€ì§€', 'ì¼ì£¼', 'ìš©ì‹ ', 'ì‚¬ì£¼í’€ì´', 'ì‹ ì‚´',
        'ëª…ë¦¬', 'ê´€ìƒ', 'ìˆ˜ìƒ', 'í’ìˆ˜', 'ì‚¬ìƒì²´ì§ˆ', 'í† ì •ë¹„ê²°', 'ì‚¼ì¬',
        'ìš´ì„¸', 'ì ìˆ ', 'í•´ì„', 'í’€ì´', 'ë¦¬ë”©', 'ì¹´ë“œ', 'í˜¸ë¡œìŠ¤ì½”í”„',
        'ì–‘ìë¦¬', 'í™©ì†Œìë¦¬', 'ìŒë‘¥ì´ìë¦¬', 'ê²Œìë¦¬', 'ì‚¬ììë¦¬', 'ì²˜ë…€ìë¦¬',
        'ì²œì¹­ìë¦¬', 'ì „ê°ˆìë¦¬', 'ê¶ìˆ˜ìë¦¬', 'ì—¼ì†Œìë¦¬', 'ë¬¼ë³‘ìë¦¬', 'ë¬¼ê³ ê¸°ìë¦¬',
        'ë©”ì´ì € ì•„ë¥´ì¹´ë‚˜', 'ë§ˆì´ë„ˆ ì•„ë¥´ì¹´ë‚˜', 'íƒ€ë¡œì¹´ë“œ',
    ],
    ja: [
        'é‹å‹¢', 'å››æŸ±æ¨å‘½', 'ã‚¿ãƒ­ãƒƒãƒˆ', 'å æ˜Ÿè¡“', 'æ˜Ÿåº§', 'ç›¸æ€§', 'é‡‘é‹', 'æ‹æ„›é‹',
        'ä»•äº‹é‹', 'å¥åº·é‹', 'ä»Šæ—¥ã®é‹å‹¢', 'æ˜æ—¥ã®é‹å‹¢', 'ä»Šé€±ã®é‹å‹¢', 'ä»Šæœˆã®é‹å‹¢',
        'ä»Šå¹´ã®é‹å‹¢', 'å¹²æ”¯', 'ç”Ÿå¹´æœˆæ—¥', 'æ—§æš¦', 'å¤§é‹', 'åç¥', 'äº”è¡Œ',
        'å¤©å¹²', 'åœ°æ”¯', 'å‘½ç†', 'äººç›¸', 'æ‰‹ç›¸', 'é¢¨æ°´', 'å ã„', 'ãƒªãƒ¼ãƒ‡ã‚£ãƒ³ã‚°',
        'ãƒ›ãƒ­ã‚¹ã‚³ãƒ¼ãƒ—', 'ã‚¢ãƒ«ã‚«ãƒŠ', 'ã‚¿ãƒ­ãƒƒãƒˆã‚«ãƒ¼ãƒ‰',
        'ç‰¡ç¾Šåº§', 'ç‰¡ç‰›åº§', 'åŒå­åº§', 'èŸ¹åº§', 'ç…å­åº§', 'ä¹™å¥³åº§',
        'å¤©ç§¤åº§', 'è åº§', 'å°„æ‰‹åº§', 'å±±ç¾Šåº§', 'æ°´ç“¶åº§', 'é­šåº§',
    ],
    en: [
        'fortune', 'horoscope', 'zodiac', 'astrology', 'tarot', 'natal chart',
        'birth chart', 'compatibility', 'love fortune', 'career fortune', 'money fortune',
        'health fortune', 'daily fortune', 'weekly fortune', 'monthly fortune', 'yearly fortune',
        'saju', 'four pillars', 'bazi', 'feng shui', 'palm reading', 'divination',
        'reading', 'card reading', 'spread', 'major arcana', 'minor arcana',
        'aries', 'taurus', 'gemini', 'cancer', 'leo', 'virgo',
        'libra', 'scorpio', 'sagittarius', 'capricorn', 'aquarius', 'pisces',
        'mercury retrograde', 'rising sign', 'moon sign', 'sun sign',
        'luck', 'destiny', 'fate', 'prediction', 'forecast',
    ],
    zh: [
        'è¿åŠ¿', 'å››æŸ±', 'å…«å­—', 'å¡”ç½—', 'å æ˜Ÿ', 'æ˜Ÿåº§', 'åˆç›˜', 'è´¢è¿', 'æ‹çˆ±è¿',
        'äº‹ä¸šè¿', 'å¥åº·è¿', 'ä»Šæ—¥è¿åŠ¿', 'æœ¬å‘¨è¿åŠ¿', 'æœ¬æœˆè¿åŠ¿', 'ä»Šå¹´è¿åŠ¿',
        'ç”Ÿè¾°', 'å†œå†', 'å¤§è¿', 'åç¥', 'äº”è¡Œ', 'å¤©å¹²', 'åœ°æ”¯', 'å‘½ç†',
        'é¢ç›¸', 'æ‰‹ç›¸', 'é£æ°´', 'å åœ', 'ç‰Œé˜µ', 'å¡”ç½—ç‰Œ',
        'ç™½ç¾Šåº§', 'é‡‘ç‰›åº§', 'åŒå­åº§', 'å·¨èŸ¹åº§', 'ç‹®å­åº§', 'å¤„å¥³åº§',
        'å¤©ç§¤åº§', 'å¤©èåº§', 'å°„æ‰‹åº§', 'æ‘©ç¾¯åº§', 'æ°´ç“¶åº§', 'åŒé±¼åº§',
    ],
};

// =============================
// ëª…ë°±íˆ ë¹„ìš´ì„¸ í‚¤ì›Œë“œ (ì°¨ë‹¨ ì‹œê·¸ë„)
// =============================
const NON_FORTUNE_KEYWORDS: string[] = [
    // í”„ë¡œê·¸ë˜ë°/IT
    'javascript', 'python', 'java', 'typescript', 'react', 'node.js', 'html', 'css',
    'sql', 'api', 'http', 'database', 'algorithm', 'function', 'class', 'import',
    'git', 'docker', 'kubernetes', 'aws', 'debugging', 'compile', 'runtime',
    'firebase', 'next.js', 'vue', 'angular', 'flutter', 'swift', 'kotlin',
    'ì½”ë”©', 'í”„ë¡œê·¸ë˜ë°', 'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°', 'ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°', 'ç¼–ç¨‹',
    'ìë°”ìŠ¤í¬ë¦½íŠ¸', 'íŒŒì´ì¬', 'íƒ€ì…ìŠ¤í¬ë¦½íŠ¸', 'íˆ¬ë‘ë¦¬ìŠ¤íŠ¸', 'ì•± ë§Œë“¤', 'ì‚¬ì´íŠ¸ ë§Œë“¤',

    // ìˆ˜í•™/ê³¼í•™
    'integral', 'derivative', 'equation', 'theorem', 'calculus', 'physics',
    'chemistry', 'biology', 'molecule', 'atom', 'quantum',
    'ë¯¸ë¶„', 'ì ë¶„', 'ë°©ì •ì‹', 'ë¯¸ì ë¶„', 'ë¬¼ë¦¬í•™', 'í™”í•™',
    'å¾®åˆ†', 'ç©åˆ†', 'æ–¹ç¨‹å¼', 'ç‰©ç†å­¦', 'åŒ–å­¦',

    // ì—­ì‚¬/ì •ì¹˜
    'world war', 'president', 'election', 'parliament', 'constitution',
    'ì„¸ê³„ëŒ€ì „', 'ëŒ€í†µë ¹', 'êµ­íšŒ', 'í—Œë²•',
    'ä¸–ç•Œå¤§æˆ¦', 'å¤§çµ±é ˜', 'å›½ä¼š', 'æ†²æ³•',

    // ì˜ë£Œ/ë²•ë¥  ì¡°ì–¸
    'prescription', 'lawsuit', 'lawsuit', 'attorney', 'diagnosis',
    'ì²˜ë°©ì „', 'ì†Œì†¡', 'ë³€í˜¸ì‚¬', 'ì§„ë‹¨ì„œ',
    'å‡¦æ–¹ç®‹', 'è¨´è¨Ÿ', 'å¼è­·å£«', 'è¨ºæ–­æ›¸',

    // ì¼ë°˜ì ì¸ ë¹„ìš´ì„¸ ìš”ì²­
    'recipe', 'translate', 'summarize', 'write code', 'write essay',
    'ë ˆì‹œí”¼', 'ë²ˆì—­', 'ìš”ì•½', 'ì½”ë“œ ì‘ì„±', 'ì—ì„¸ì´',
    'ìš”ë¦¬ë²•', 'ê¹€ì¹˜', 'ì°Œê°œ', 'ë³¶ìŒë°¥',
    'ãƒ¬ã‚·ãƒ”', 'ç¿»è¨³', 'è¦ç´„', 'ã‚³ãƒ¼ãƒ‰ä½œæˆ',
];

// =============================
// ì°¨ë‹¨ ì‹œ ì•ˆë‚´ ë©”ì‹œì§€ (ë‹¤êµ­ì–´)
// =============================
const BLOCKED_MESSAGES: Record<string, string> = {
    ko: 'ì €ëŠ” ìš´ì„¸/ì‚¬ì£¼/íƒ€ë¡œ/ì ì„±ìˆ  ë“± ìš´ì„¸ ê´€ë ¨ ì§ˆë¬¸ì—ë§Œ ë‹µë³€í•  ìˆ˜ ìˆì–´ìš”. ğŸ”® ìš´ì„¸ì™€ ê´€ë ¨ëœ ì§ˆë¬¸ìœ¼ë¡œ ë‹¤ì‹œ ë¶€íƒë“œë¦´ê²Œìš”!',
    ja: 'ç§ã¯é‹å‹¢ãƒ»å››æŸ±æ¨å‘½ãƒ»ã‚¿ãƒ­ãƒƒãƒˆãƒ»å æ˜Ÿè¡“ãªã©ã€å ã„ã«é–¢ã™ã‚‹è³ªå•ã®ã¿ãŠç­”ãˆã§ãã¾ã™ã€‚ğŸ”® å ã„ã«é–¢ã™ã‚‹è³ªå•ã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼',
    en: 'I can only answer questions related to fortune telling, horoscopes, tarot, and astrology. ğŸ”® Please ask a fortune-related question!',
    zh: 'æˆ‘åªèƒ½å›ç­”å…³äºè¿åŠ¿ã€å…«å­—ã€å¡”ç½—ã€å æ˜Ÿç­‰å åœç›¸å…³çš„é—®é¢˜ã€‚ğŸ”® è¯·æå‡ºä¸å åœç›¸å…³çš„é—®é¢˜ï¼',
};

/**
 * ì‚¬ìš©ì ì…ë ¥ì´ ìš´ì„¸ ë„ë©”ì¸ ì§ˆë¬¸ì¸ì§€ íŒë³„
 * 
 * 1ì°¨: ìš´ì„¸ í‚¤ì›Œë“œê°€ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ì¦‰ì‹œ í—ˆìš©
 * 2ì°¨: ë¹„ìš´ì„¸ í‚¤ì›Œë“œë§Œ ìˆìœ¼ë©´ ì°¨ë‹¨
 * 3ì°¨: ë‘˜ ë‹¤ ì—†ìœ¼ë©´ í—ˆìš© (ê´€ëŒ€í•œ ê¸°ë³¸ ì •ì±…)
 */
export function isFortuneQuery(input: string, locale: string = 'ko'): GuardrailResult {
    if (!input || input.trim().length === 0) {
        return { allowed: false, reason: getBlockedMessage(locale) };
    }

    const normalized = input.toLowerCase().trim();

    // 1ì°¨: ìš´ì„¸ ê´€ë ¨ í‚¤ì›Œë“œ ì²´í¬ â€” í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì¦‰ì‹œ í—ˆìš©
    const localeKeywords = FORTUNE_KEYWORDS[locale] || FORTUNE_KEYWORDS.en;
    const allFortuneKeywords = [...localeKeywords, ...FORTUNE_KEYWORDS.en]; // í˜„ì¬ ë¡œì¼€ì¼ + ì˜ì–´ fallback

    for (const keyword of allFortuneKeywords) {
        if (normalized.includes(keyword.toLowerCase())) {
            return { allowed: true };
        }
    }

    // 2ì°¨: ë¹„ìš´ì„¸ í‚¤ì›Œë“œ ì²´í¬ â€” í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ì°¨ë‹¨
    for (const keyword of NON_FORTUNE_KEYWORDS) {
        if (normalized.includes(keyword.toLowerCase())) {
            return { allowed: false, reason: getBlockedMessage(locale) };
        }
    }

    // 3ì°¨: íŒë³„ ë¶ˆê°€ â†’ ê´€ëŒ€í•˜ê²Œ í—ˆìš© (false negative í—ˆìš©)
    // ìš´ì„¸ ì„œë¹„ìŠ¤ì˜ ë§¥ë½ì—ì„œ ìì—°ìŠ¤ëŸ¬ìš´ ì§ˆë¬¸ì€ í†µê³¼ì‹œí‚´
    return { allowed: true };
}

/** ì°¨ë‹¨ ì•ˆë‚´ ë©”ì‹œì§€ ë°˜í™˜ */
export function getBlockedMessage(locale: string): string {
    return BLOCKED_MESSAGES[locale] || BLOCKED_MESSAGES.en;
}
